#!/usr/bin/env ruby

# aws configservice select-resource-config --expression "SELECT *, configuration, tags" | jq '.Results[] | fromjson'

require 'aws-sdk-configservice'
require 'json'

client = Aws::ConfigService::Client.new

def find_resources(client, next_token=nil)
  resp = client.select_resource_config(
    expression: "SELECT *, configuration, tags",
    next_token: next_token,
    limit: 100,
  )
  return resp[:results].map { |r| JSON.parse(r) }, resp[:next_token]
end

next_token = nil
begin
  resources, next_token = find_resources(client, next_token)
  puts resources
end while next_token != ""
